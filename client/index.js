// „Éñ„É©„Ç¶„Ç∂‰∏ä„ÅßÂãï„ÅèÁ¥îÁ≤ã„Å™ DOM Êìç‰Ωú„Ç≥„Éº„Éâ
document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('addForm');
    form.addEventListener('submit', function(e)  {
      e.preventDefault();
  
      // ÂÖ•ÂäõÂÄ§ÂèñÂæó
      const title       = document.getElementById('title').value.trim();
      const author      = document.getElementById('author').value.trim();
      const description = document.getElementById('description').value.trim();
      const category    = document.getElementById('category').value;
      const imageUrl    = document.getElementById('imageUrl').value.trim();
  
      // „Çµ„Éº„Éê„Éº„Å∏ POST „Åô„Çã„Å®„Åç„ÇÇ require „ÅØ‰∏çË¶Å
      try {
        async function postData() {
          const res = await fetch('/api/resource', {
            method:  'POST',
            headers: { 'Content-Type': 'application/json' },
            body:    JSON.stringify({ title, author, description, category, imageUrl })
          });
          if (!res.ok) throw new Error(res.status);

          // ÁîªÈù¢„Å´„Ç´„Éº„Éâ„ÇíËøΩÂä†
          const card = document.createElement('div');
          card.className = 'book-card';
        }
        postData();
        card.innerHTML = `
          <div class="book-image-container">
            <img src="${imageUrl}" class="book-image" alt="${title} Ë°®Á¥ô">
          </div>
          <div class="book-info">
            <h2 class="book-title">${title}</h2>
            <p class="book-author">${author}</p>
            <p class="book-description">${description}</p>
            <span class="category">${category}</span>
          </div>
        `;
        document.getElementById(`grid-${category}`).appendChild(card);
  
        form.reset();
        new bootstrap.Tab(document.querySelector('#view-tab')).show();
      } catch (err) {
        console.error(err);
        alert('ËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
      }
    });
    
      if (window.Swiper) {
    new Swiper('.swiper-container', {
      loop: true,
      pagination: {
        el: '.swiper-pagination',
        clickable: true,
      },
      navigation: {
        nextEl: '.swiper-button-next',
        prevEl: '.swiper-button-prev',
      },
      autoplay: {
        delay: 5000,
        disableOnInteraction: true,
      },
      effect: 'coverflow',
      speed: 1500,
    });
  }

  // „É©„Ç§„Éñ„Éï„Ç£„É´„Çø„ÉºÊ©üËÉΩ
  const searchInput = document.getElementById('searchInput');
  searchInput.addEventListener('input', () => {
    const keyword = searchInput.value.trim().toLowerCase();
    document.querySelectorAll('.book-card').forEach(card => {
      const title = card.querySelector('.book-title').textContent.toLowerCase();
      const author = card.querySelector('.book-author').textContent.toLowerCase();
      card.classList.toggle('hidden', !(title.includes(keyword) || author.includes(keyword)));
    });
  });

  // // ÁõÆÊ¨°ÔºàTable of ContentsÔºâÁîüÊàê
  // const toc = document.querySelector('.toc');
  // document.querySelectorAll('.book-section').forEach(section => {
  //   const id = section.id;
  //   const title = section.querySelector('h2').textContent;
  //   const li = document.createElement('li');
  //   const a = document.createElement('a');
  //   a.href = `#${id}`;
  //   a.textContent = title;
  //   a.addEventListener('click', e => {
  //     e.preventDefault();
  //     document.getElementById(id).scrollIntoView({ behavior: 'smooth' });
  //   });
  //   li.appendChild(a);
  //   toc.appendChild(li);
  // });

  // „Ç´„Çπ„Çø„É†„Ç≥„É≥„Éà„É≠„Éº„É´Ôºà„Ç≥„É°„É≥„Éà„É¢„Éº„ÉÄ„É´Ôºâ
  document.querySelectorAll('.swiper-slide').forEach(slide => {
    const commentBtn = document.createElement('button');
    commentBtn.textContent = 'üí¨';
    commentBtn.className = 'comment-btn';
    slide.appendChild(commentBtn);
    commentBtn.addEventListener('click', () => {
      document.getElementById('commentModal').classList.remove('hidden');
    });
  });
  document.getElementById('modalClose').addEventListener('click', () => {
    document.getElementById('commentModal').classList.add('hidden');
  });
  document.getElementById('commentSubmit').addEventListener('click', () => {
    const text = document.getElementById('commentText').value.trim();
    if (text) alert(`„Ç≥„É°„É≥„Éà: ${text}`);
    document.getElementById('commentText').value = '';
    document.getElementById('commentModal').classList.add('hidden');
  });

  // „É©„É≥„Ç≠„É≥„Ç∞Ë°®Á§∫Êõ¥Êñ∞
  function updateRanking() {
    const cardsArr = Array.from(document.querySelectorAll('.book-card'));
    cardsArr.sort((a, b) => Number(b.dataset.likes) - Number(a.dataset.likes));
    const top3 = cardsArr.slice(0, 3);
    const rankingList = document.getElementById('rankingList');
    rankingList.innerHTML = '';
    top3.forEach((card, index) => {
      const col = document.createElement('div');
      col.className = 'col-md-4';
      const clone = card.cloneNode(true);
      clone.classList.remove('hidden');
      
      // È†Ü‰Ωç„É©„Éô„É´„ÇíËøΩÂä†
      const rankLabel = document.createElement('div');
      rankLabel.className = 'ranking-label';
      const rankText = ['1‰Ωç', '2‰Ωç', '3‰Ωç'][index];
      rankLabel.textContent = rankText;
      rankLabel.style.cssText = `
        position: absolute;
        top: -10px;
        left: -10px;
        background: #FFD700;
        color: #333;
        padding: 5px 10px;
        border-radius: 15px;
        font-weight: bold;
        font-size: 0.9rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        z-index: 10;
      `;
      
      // È†Ü‰Ωç„Å´Âøú„Åò„Å¶Ëâ≤„ÇíÂ§âÊõ¥
      if (index === 0) rankLabel.style.background = '#FFD700'; // Èáë
      else if (index === 1) rankLabel.style.background = '#C0C0C0'; // ÈäÄ
      else if (index === 2) rankLabel.style.background = '#CD7F32'; // ÈäÖ
      
      col.style.position = 'relative';
      col.appendChild(rankLabel);
      col.appendChild(clone);
      rankingList.appendChild(col);
    });
  }
  updateRanking();
  // „É¨„Éì„É•„ÉºË°®Á§∫„Éà„Ç∞„É´Ôºà„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñãÈñâÔºâ
  document.querySelectorAll('.review-toggle').forEach(toggleBtn => {
    toggleBtn.addEventListener('click', () => {
      const reviewDiv = toggleBtn.nextElementSibling;
      if (reviewDiv) {
        reviewDiv.classList.toggle('hidden');
      }
    });
  });

  // „É¨„Ç§„ÉÜ„Ç£„É≥„Ç∞ÔºÜ„É¨„Éì„É•„ÉºÊ©üËÉΩ
  const ratingCards = document.querySelectorAll('.book-card');
  let storedRatings = JSON.parse(localStorage.getItem('ratings') || '{}');
  let storedReviews = JSON.parse(localStorage.getItem('reviews') || '{}');

  ratingCards.forEach((card, idx) => {
    const ratingDiv = card.querySelector('.rating');
    if (!ratingDiv) {
      // Skip cards that do not have a rating section
      return;
    }
    const stars     = ratingDiv.querySelectorAll('.star');
    // ÂàùÊúüÁä∂ÊÖã„ÇíÂæ©ÂÖÉ
    const saved = storedRatings[idx] || 0;
    ratingDiv.dataset.rating = saved;
    stars.forEach(star => {
      if (Number(star.dataset.value) <= saved) star.classList.add('filled');
      star.addEventListener('click', e => {
        const val = Number(e.target.dataset.value);
        storedRatings[idx] = val;
        localStorage.setItem('ratings', JSON.stringify(storedRatings));
        stars.forEach(s => s.classList.toggle('filled', Number(s.dataset.value) <= val));
      });
    });

    // „É¨„Éì„É•„Éº„ÅÆÂæ©ÂÖÉ„Éª‰øùÂ≠ò
    const reviewText = card.querySelector('.review-text');
    const reviewBtn  = card.querySelector('.review-submit');
    if (reviewText && reviewBtn) {
      reviewText.value = storedReviews[idx] || '';
      reviewBtn.addEventListener('click', () => {
        storedReviews[idx] = reviewText.value.trim();
        localStorage.setItem('reviews', JSON.stringify(storedReviews));
        alert('„É¨„Éì„É•„Éº„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
      });
    }
  });

  // Ë™≠Êõ∏ÈÄ≤Êçó„Éà„É©„ÉÉ„Ç´„ÉºÊ©üËÉΩ
  const secondaryColor = getComputedStyle(document.documentElement).getPropertyValue('--secondary-color').trim();
  document.querySelectorAll('.book-card').forEach((card, idx) => {
    const canvas = card.querySelector('.progress-canvas');
    const decBtn = card.querySelector('.progress-decrement');
    const incBtn = card.querySelector('.progress-increment');
    if (!canvas || !decBtn || !incBtn) return;
    const ctx = canvas.getContext('2d');
    let progress = Number(card.dataset.progress) || 0;
    const radius = canvas.width / 2 - 5;
    const cx = canvas.width / 2;
    const cy = canvas.height / 2;

    function drawProgress(pct) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      // ËÉåÊôØÂÜÜ
      ctx.beginPath();
      ctx.arc(cx, cy, radius, 0, Math.PI * 2);
      ctx.strokeStyle = '#eee';
      ctx.lineWidth = 5;
      ctx.stroke();
      // ÈÄ≤ÊçóÂÜÜ
      ctx.beginPath();
      ctx.arc(cx, cy, radius, -Math.PI / 2, -Math.PI / 2 + (Math.PI * 2 * pct / 100));
      ctx.strokeStyle = secondaryColor;
      ctx.lineWidth = 5;
      ctx.stroke();
      // ‰∏≠Â§Æ„Å´ÈÄ≤ÊçóÂ∫¶„ÅÆÊï∞Â≠ó„ÇíË°®Á§∫
      ctx.fillStyle = secondaryColor;
      ctx.font = 'bold 12px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(pct + '%', cx, cy);
    }

    // ÂàùÊúüÊèèÁîª
    drawProgress(progress);

    // „Éá„Éº„ÇøÂ±ûÊÄß„Å´‰øùÂ≠ò
    card.dataset.progress = progress;

    decBtn.addEventListener('click', () => {
      progress = Math.max(0, progress - 10);
      drawProgress(progress);
      card.dataset.progress = progress;
      localStorage.setItem('progress', JSON.stringify(
        Object.assign(
          JSON.parse(localStorage.getItem('progress') || '{}'),
          { [idx]: progress }
        )
      ));
    });

    incBtn.addEventListener('click', () => {
      progress = Math.min(100, progress + 10);
      drawProgress(progress);
      card.dataset.progress = progress;
      localStorage.setItem('progress', JSON.stringify(
        Object.assign(
          JSON.parse(localStorage.getItem('progress') || '{}'),
          { [idx]: progress }
        )
      ));
    });

    // „É≠„Éº„Ç´„É´‰øùÂ≠ò„Åã„ÇâÂæ©ÂÖÉ
    const stored = JSON.parse(localStorage.getItem('progress') || '{}');
    if (stored[idx] != null) {
      progress = stored[idx];
      drawProgress(progress);
      card.dataset.progress = progress;
    }
  });
});